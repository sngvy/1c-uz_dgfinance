&НаКлиенте
Процедура ЗавершитьРазговор(Команда)
	Попытка
		ФормаНабора = ПолучитьФорму("Обработка.бит_Битфон.Форма.ОсновнаяФорма");
		Если ФормаНабора.ИдетРазговор = Истина Тогда
			ФормаНабора.КнОтбой(Неопределено);
		КонецЕсли;
	Исключение
		Предупреждение("БИТ.Phone не подключен!");
	КонецПопытки
КонецПроцедуры

&НаКлиенте
Процедура ОбработчикСобытияСостояниеЗвонка(Данные)

	//////////////////////////////////
	// Обработчик состояния звонка //
	////////////////////////////////
	
	Если Состояние = "ЗвонокПрерван" Тогда
		ЭтаФорма.ЗвонокПрерван = Истина;
		ЭтаФорма.СтатусАбонентаSIPОбновлен = Ложь;
		Если ЭтаФорма.ДлительностьРазговора = "0:00:00" Тогда
			ПоказатьОповещениеПользователя("БИТ.Phone",,"Звонок был сброшен",БиблиотекаКартинок.Предупреждение32);
		КонецЕсли;
		Если ЭтаФорма.ДлительностьРазговора <> "0:00:00" Тогда
			Пояснение = "Разговор завершен. Длительность разговора "+ЭтаФорма.ДлительностьРазговора;
			ПоказатьОповещениеПользователя("БИТ.Phone",,Пояснение,БиблиотекаКартинок.Информация32);
		КонецЕсли;
		
		Пока ЭтаФорма.СтатусАбонентаSIPОбновлен = Ложь Цикл 
			ОбновитьСтатусАбонентаSIP(Неопределено);
			Если ЭтаФорма.ЗвонокПрерван = Истина И ЭтаФорма.СтатусАбонентаSIPОбновлен = Истина Тогда
				ЭтаФорма.КнОтключить(Неопределено);
				ЭтаФорма.ЗвонокПрерван = Ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
&НаКлиенте
Процедура ОбновитьСтатусАбонентаSIP(ИдентификаторАбонента)

	//////////////////////////////////
	// Обработчик состояния звонка //
	////////////////////////////////
	
	СтрокаЗапроса = "ping -n 1 -w "+Формат(1000 * 3, "ЧДЦ=0; ЧГ=") + " 10.10.0.16"; 
	WshShell = Новый COMОбъект("WScript.Shell"); 
	WshShell.Run(СтрокаЗапроса, 0, -1);
	ЭтаФорма.СтатусАбонентаSIPОбновлен = Истина;

