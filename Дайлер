Процедура ФормированиеСписковАвтообзвона() Экспорт

	// Код от 29 марта
		
	// Установить константы разреза дат
	// Не звоним, если было взаимодействие в начале недели
	НачалоНедели = НачалоНедели(ТекущаяДата());
	// Не звоним, если было взаимодействие в разрезе текущего дня
	Сегодня = НачалоДня(ТекущаяДата());
	// Не звоним, если было взаимодействие в разрезе одного дня
	Вчера = НачалоДня(ТекущаяДата())-1;
	// Не звоним, если было взаисмодействие в разрезе двух дней
	Позавчера = НачалоДня(ТекущаяДата())-2;
	// И НЕ Мероприятие.Результат.Наименование = ""Автоответчик"" - исключает автоответчики в разрезе
	// Конец
	
	// Список по дальним регионам (МСК+4...МСК+9)
	
	СписокАвтообзвона = Справочники.СписокДляАвтообзвона.СоздатьЭлемент();
	СписокАвтообзвона.Наименование = "Дальние регионы" + ЛЕВ(Строка(ТекущаяДата()),10);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Задача.Мероприятие КАК Мероприятие
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|		ПО Мероприятие.Объект = ДолговыеОбязательства.Ссылка
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/McMurdo""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Casey""	
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|   И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""AET""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Chita""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Brunei""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""ACT""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Davis""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	// Прогоним еще один цикл, чтобы добавить должников, по которым ранее не было взаимодействия
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/McMurdo""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Casey""	
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|   И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""AET""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Chita""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Brunei""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""ACT""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Davis""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если НЕ КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	//СписокАвтообзвона.Записать();
	ЗагрузитьНаСервере(СписокАвтообзвона);
	СписокАвтообзвона.Записать();
	
	// Список по основным регионам (МСК+0...МСК+3)
	
	СписокАвтообзвона = Справочники.СписокДляАвтообзвона.СоздатьЭлемент();
	СписокАвтообзвона.Наименование = "Основной" + ЛЕВ(Строка(ТекущаяДата()),10);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Задача.Мероприятие КАК Мероприятие
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|		ПО Мероприятие.Объект = ДолговыеОбязательства.Ссылка
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Vostok""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Mawson""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Baku""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Syowa""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""EET""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели"" И НЕ Мероприятие.Результат.Наименование = ""Автоответчик""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	// Прогоним еще один цикл, чтобы добавить должников, по которым ранее не было взаимодействия
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Vostok""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Mawson""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Asia/Baku""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""Antarctica/Syowa""
	|	ИЛИ ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И ДолговыеОбязательства.Контрагенты.Значение.ЧасовойПояс = ""EET""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если НЕ КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	//СписокАвтообзвона.Записать();
	ЗагрузитьНаСервере(СписокАвтообзвона);
	СписокАвтообзвона.Записать();
	
	// Список по новым реестрам
	
	СписокАвтообзвона = Справочники.СписокДляАвтообзвона.СоздатьЭлемент();
	СписокАвтообзвона.Наименование = "Новые реестры" + ЛЕВ(Строка(ТекущаяДата()),10);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Задача.Мероприятие КАК Мероприятие
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|		ПО Мероприятие.Объект = ДолговыеОбязательства.Ссылка
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""Новые""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	// Прогоним еще один цикл, чтобы добавить должников, по которым ранее не было взаимодействия

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""Новые""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если НЕ КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	//СписокАвтообзвона.Записать();
	ЗагрузитьНаСервере(СписокАвтообзвона);
	СписокАвтообзвона.Записать();
	
	// Список по просроченным обещаниям
	// Здесь только результативные звонки
	
	СписокАвтообзвона = Справочники.СписокДляАвтообзвона.СоздатьЭлемент();
	СписокАвтообзвона.Наименование = "Просроченные" + ЛЕВ(Строка(ТекущаяДата()),10);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Задача.Мероприятие КАК Мероприятие
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|		ПО Мероприятие.Объект = ДолговыеОбязательства.Ссылка
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И Мероприятие.Результат.Наименование = ""Обещание оплаты""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	//СписокАвтообзвона.Записать();
	ЗагрузитьНаСервере(СписокАвтообзвона);
	СписокАвтообзвона.Записать();
	
	// Список по отказникам
	// Здесь только результативные звонки
	
	СписокАвтообзвона = Справочники.СписокДляАвтообзвона.СоздатьЭлемент();
	СписокАвтообзвона.Наименование = "Отказники" + ЛЕВ(Строка(ТекущаяДата()),10);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДолговыеОбязательства.Ссылка КАК Ссылка
	|ИЗ
	|	Задача.Мероприятие КАК Мероприятие
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДолговыеОбязательства КАК ДолговыеОбязательства
	|		ПО Мероприятие.Объект = ДолговыеОбязательства.Ссылка
	|ГДЕ
	|	ДолговыеОбязательства.ДополнительныеРеквизиты.Значение.Наименование = ""В работе""
	|	И Мероприятие.Результат.Наименование = ""Отказ должника""
    |   И НЕ Мероприятие.ДатаВыполнения = ""Сегодня"" И НЕ Мероприятие.ДатаВыполнения = ""Вчера"" И НЕ Мероприятие.ДатаВыполнения = ""Позавчера"" И НЕ Мероприятие.ДатаВыполнения = ""НачалоНедели""
	|";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.Ссылка.ПолучитьОбъект();
		Если КонтрольСобытий.РезультативныеЗвонки(Договор.Должник) Тогда
			стр = СписокАвтообзвона.Объекты.Добавить();
			стр.Объект = Договор.Ссылка;
			Должник = Договор.Должник.ПолучитьОбъект();
			Для каждого стр из Должник.Телефоны Цикл
				Если строка(стр.ВидТелефона) = "Мобильный" Тогда 
					стрТел = СписокАвтообзвона.СписокДляАО.Добавить();
					стрТел.Должник = Договор.Должник;
					стрТел.НомерТелефона = стр.Номер;
					// Фикс для нашей АТС
					стрТел.НомерТелефона = СтрСоединить(СтрРазделить(стр.Номер, "+( )"), "");
					// Конец
					стрТел.СтрокаАвтообзвона = Договор;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	//СписокАвтообзвона.Записать();
	ЗагрузитьНаСервере(СписокАвтообзвона);
	СписокАвтообзвона.Записать();
	
КонецПроцедуры
